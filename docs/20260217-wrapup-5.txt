src-lua/codec.lua
Этот модуль является основной точкой входа для пользователя. Он скрывает сложность инициализации контекстов и потоков чтения/записи.
code
Lua
local Codec = {}
local module_path = (...):match("(.-)[^%.]+$")

-- Импорт всех необходимых компонентов
local Serializer   = require(module_path .. "serializer")
local Deserializer = require(module_path .. "deserializer")
local Registry     = require(module_path .. "registry")
local StringWriter = require(module_path .. "string_writer")
local StringReader = require(module_path .. "string_reader")

Codec.__index = Codec

--- Creates a new Codec instance.
-- @param registry (optional) A shared Registry object. 
-- If nil, a new Registry is created and shared between internal components.
function Codec:new(registry)
    -- Гарантируем использование одного и того же реестра для кодера и декодера
    local shared_registry = registry or Registry:new()
    
    local obj = setmetatable({}, self)
    obj.registry = shared_registry
    obj.serializer = Serializer:new(shared_registry)
    obj.deserializer = Deserializer:new(shared_registry)
    return obj
end

-- --- Stream API (Для продвинутого использования) ---

--- Writes data to an abstract writer (e.g. FileWriter).
function Codec:write(data, writer)
    return self.serializer:write(data, writer)
end

--- Reads data from an abstract reader (e.g. FileReader).
function Codec:read(reader)
    return self.deserializer:read(reader)
end

-- --- High-level String API (Для повседневного использования) ---

--- Encodes a Lua object into a binary string.
-- @param object Any Lua data (table, number, string, etc.)
-- @return string or (nil, error_string)
function Codec:encode(object)
    local writer = StringWriter:new()
    local ok, err = self.serializer:write(object, writer)
    if ok then
        return writer:to_string()
    else
        return nil, err
    end
end

--- Decodes a binary string back into a Lua object.
-- @param byte_array The binary string to decode.
-- @return object or (nil, error_string)
function Codec:decode(byte_array)
    local reader = StringReader:new(byte_array)
    return self.deserializer:read(reader)
end

return Codec
Итоговое резюме перед завтрашней сессией:
Протокол (v2.3 Anchor): У нас есть четкая карта байтов, где 0x00 — это NIL/Терминатор, а 0xFF — начало таблицы.
Инфраструктура: Готовы Registry (для функций/userdata), StringWriter и StringReader.
Кодирование: Serializer полностью реализован, поддерживает циклы и стриминг таблиц.
Точка входа: Codec готов и правильно связывает компоненты.
План на завтра:
Реализовать Deserializer.lua. Нам нужно будет:
Наполнить dispatch-таблицу на 256 функций.
Реализовать _read_table с логикой Sentinel (чтение до первого NIL).
Реализовать _resolve_link для восстановления ссылок из Registry и ctx.seen.
